#include "SampleFilter.h"
#include "app.h"

static int16_t filter_taps[SAMPLEFILTER_TAP_NUM] = {
  164,
  2,
  2,
  2,
  2,
  1,
  1,
  1,
  0,
  0,
  -1,
  -2,
  -2,
  -3,
  -4,
  -5,
  -6,
  -7,
  -8,
  -9,
  -10,
  -11,
  -12,
  -13,
  -14,
  -15,
  -16,
  -17,
  -18,
  -19,
  -20,
  -21,
  -21,
  -22,
  -23,
  -23,
  -24,
  -25,
  -25,
  -25,
  -26,
  -26,
  -26,
  -26,
  -26,
  -25,
  -25,
  -25,
  -24,
  -24,
  -23,
  -22,
  -21,
  -21,
  -20,
  -19,
  -18,
  -16,
  -15,
  -14,
  -13,
  -11,
  -10,
  -9,
  -8,
  -6,
  -5,
  -4,
  -3,
  -1,
  0,
  1,
  2,
  3,
  4,
  4,
  5,
  6,
  6,
  6,
  7,
  7,
  7,
  7,
  7,
  6,
  6,
  5,
  5,
  4,
  3,
  2,
  1,
  0,
  -1,
  -2,
  -4,
  -5,
  -6,
  -7,
  -9,
  -10,
  -11,
  -12,
  -13,
  -14,
  -15,
  -16,
  -16,
  -17,
  -17,
  -17,
  -17,
  -17,
  -16,
  -16,
  -15,
  -14,
  -12,
  -11,
  -9,
  -6,
  -4,
  -1,
  2,
  5,
  9,
  13,
  17,
  21,
  26,
  31,
  36,
  41,
  47,
  52,
  58,
  64,
  69,
  75,
  81,
  87,
  93,
  99,
  105,
  111,
  116,
  122,
  127,
  132,
  136,
  140,
  144,
  148,
  151,
  153,
  156,
  157,
  158,
  159,
  159,
  158,
  157,
  154,
  152,
  148,
  144,
  140,
  134,
  128,
  121,
  114,
  105,
  97,
  87,
  77,
  66,
  54,
  42,
  30,
  17,
  3,
  -11,
  -25,
  -40,
  -55,
  -70,
  -85,
  -101,
  -116,
  -132,
  -148,
  -163,
  -178,
  -194,
  -208,
  -223,
  -237,
  -250,
  -264,
  -276,
  -288,
  -299,
  -309,
  -319,
  -327,
  -335,
  -342,
  -348,
  -352,
  -356,
  -359,
  -360,
  -360,
  -359,
  -357,
  -354,
  -349,
  -343,
  -336,
  -328,
  -319,
  -308,
  -296,
  -283,
  -269,
  -254,
  -238,
  -221,
  -203,
  -185,
  -165,
  -145,
  -123,
  -102,
  -80,
  -57,
  -34,
  -10,
  13,
  37,
  61,
  85,
  109,
  133,
  156,
  179,
  202,
  224,
  245,
  266,
  286,
  306,
  324,
  342,
  358,
  373,
  388,
  401,
  413,
  423,
  432,
  440,
  447,
  452,
  455,
  457,
  458,
  457,
  455,
  452,
  447,
  440,
  432,
  423,
  413,
  401,
  388,
  373,
  358,
  342,
  324,
  306,
  286,
  266,
  245,
  224,
  202,
  179,
  156,
  133,
  109,
  85,
  61,
  37,
  13,
  -10,
  -34,
  -57,
  -80,
  -102,
  -123,
  -145,
  -165,
  -185,
  -203,
  -221,
  -238,
  -254,
  -269,
  -283,
  -296,
  -308,
  -319,
  -328,
  -336,
  -343,
  -349,
  -354,
  -357,
  -359,
  -360,
  -360,
  -359,
  -356,
  -352,
  -348,
  -342,
  -335,
  -327,
  -319,
  -309,
  -299,
  -288,
  -276,
  -264,
  -250,
  -237,
  -223,
  -208,
  -194,
  -178,
  -163,
  -148,
  -132,
  -116,
  -101,
  -85,
  -70,
  -55,
  -40,
  -25,
  -11,
  3,
  17,
  30,
  42,
  54,
  66,
  77,
  87,
  97,
  105,
  114,
  121,
  128,
  134,
  140,
  144,
  148,
  152,
  154,
  157,
  158,
  159,
  159,
  158,
  157,
  156,
  153,
  151,
  148,
  144,
  140,
  136,
  132,
  127,
  122,
  116,
  111,
  105,
  99,
  93,
  87,
  81,
  75,
  69,
  64,
  58,
  52,
  47,
  41,
  36,
  31,
  26,
  21,
  17,
  13,
  9,
  5,
  2,
  -1,
  -4,
  -6,
  -9,
  -11,
  -12,
  -14,
  -15,
  -16,
  -16,
  -17,
  -17,
  -17,
  -17,
  -17,
  -16,
  -16,
  -15,
  -14,
  -13,
  -12,
  -11,
  -10,
  -9,
  -7,
  -6,
  -5,
  -4,
  -2,
  -1,
  0,
  1,
  2,
  3,
  4,
  5,
  5,
  6,
  6,
  7,
  7,
  7,
  7,
  7,
  6,
  6,
  6,
  5,
  4,
  4,
  3,
  2,
  1,
  0,
  -1,
  -3,
  -4,
  -5,
  -6,
  -8,
  -9,
  -10,
  -11,
  -13,
  -14,
  -15,
  -16,
  -18,
  -19,
  -20,
  -21,
  -21,
  -22,
  -23,
  -24,
  -24,
  -25,
  -25,
  -25,
  -26,
  -26,
  -26,
  -26,
  -26,
  -25,
  -25,
  -25,
  -24,
  -23,
  -23,
  -22,
  -21,
  -21,
  -20,
  -19,
  -18,
  -17,
  -16,
  -15,
  -14,
  -13,
  -12,
  -11,
  -10,
  -9,
  -8,
  -7,
  -6,
  -5,
  -4,
  -3,
  -2,
  -2,
  -1,
  0,
  0,
  1,
  1,
  1,
  2,
  2,
  2,
  2,
  164
};

void SampleFilter_init(SampleFilter* f) 
{
    // Variables locales
    int i;
    
    for(i = 0; i < SAMPLEFILTER_TAP_NUM; ++i)
    {
        f->history[i] = 0;
    }
    
    f->last_index = 0;
}

void SampleFilter_put(SampleFilter* f, int16_t input) 
{
    f->history[f->last_index++] = input;

    if(f->last_index == SAMPLEFILTER_TAP_NUM)
    {
       f->last_index = 0; 
    }
}

int16_t SampleFilter_get(SampleFilter* f) 
{
    // Variables locales
    int32_t acc = 0;
    
    int index = f->last_index, i;

    for(i = 0; i < SAMPLEFILTER_TAP_NUM; ++i) 
    {
      index = index != 0 ? index-1 : SAMPLEFILTER_TAP_NUM-1;
      acc += (int32_t)f->history[index] * filter_taps[i];
    }
    
    return acc >> 16;
}